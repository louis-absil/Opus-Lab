rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: vérifier si l'utilisateur est authentifié
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: vérifier si l'utilisateur est le propriétaire
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function: vérifier si l'utilisateur est professeur
    function isTeacher() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }
    
    // Collection users
    match /users/{userId} {
      // Lecture : son propre document, ou (si professeur) tout document élève ou professeur (catalogue / annuaire)
      allow read: if isOwner(userId) 
                  || (isTeacher() && resource.data.role in ['student', 'teacher']);
      
      // Création : uniquement son propre document avec les champs requis
      allow create: if isOwner(userId) 
                   && request.resource.data.keys().hasAll(['email', 'displayName', 'role', 'xp'])
                   && request.resource.data.role in ['student', 'teacher']
                   && request.resource.data.xp is int
                   && request.resource.data.xp >= 0;
      
      // Mise à jour : uniquement son propre document, SAUF le champ role (géré par le système)
      allow update: if isOwner(userId)
                   && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])
                       || resource.data.role == request.resource.data.role);
      
      // Suppression : interdite (les comptes ne peuvent pas être supprimés côté client)
      allow delete: if false;
    }
    
    // Collection exercises
    match /exercises/{exerciseId} {
      // Lecture : 
      // - Exercices publiés : lecture publique (même sans authentification)
      // - Exercices draft : uniquement par l'auteur
      allow read: if resource.data.status == 'published' 
                 || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      
      // Création : uniquement pour les professeurs authentifiés
      allow create: if isTeacher()
                   && request.resource.data.authorId == request.auth.uid
                   && request.resource.data.keys().hasAll(['authorId', 'authorName', 'status', 'video', 'settings', 'markers'])
                   && request.resource.data.status in ['draft', 'published'];
      
      // Mise à jour : uniquement par l'auteur
      allow update: if isAuthenticated() 
                   && resource.data.authorId == request.auth.uid
                   && request.resource.data.authorId == resource.data.authorId; // L'auteur ne peut pas changer
      
      // Suppression : uniquement par l'auteur
      allow delete: if isAuthenticated() 
                   && resource.data.authorId == request.auth.uid;
    }
    
    // Collection attempts
    match /attempts/{attemptId} {
      // Lecture : ses propres tentatives, ou (si professeur) toutes les tentatives (détail élève)
      allow read: if isAuthenticated() 
                 && (resource.data.userId == request.auth.uid || isTeacher());
      
      // Création : un utilisateur authentifié peut créer une tentative avec son propre userId (authorId optionnel)
      allow create: if isAuthenticated() 
                   && request.resource.data.userId == request.auth.uid
                   && request.resource.data.keys().hasAll(['userId', 'exerciseId', 'userAnswers', 'correctAnswers', 'score', 'correctCount', 'totalQuestions']);
      
      // Mise à jour : interdite (les tentatives sont immuables)
      allow update: if false;
      
      // Suppression : interdite
      allow delete: if false;
    }
    
    // Collection modules
    match /modules/{moduleId} {
      // Lecture : autorisée pour tous les utilisateurs authentifiés (étudiants et professeurs)
      // Cela permet get (lecture d'un document) et list (lecture de la collection)
      allow read: if isAuthenticated();
      
      // Écriture : uniquement pour les professeurs
      allow create, update, delete: if isTeacher();
    }
    
    // Collection hints
    match /hints/{hintId} {
      // Lecture : autorisée pour tous les utilisateurs authentifiés (étudiants et professeurs)
      // Cela permet get (lecture d'un document) et list (lecture de la collection)
      allow read: if isAuthenticated();
      
      // Écriture : uniquement pour les professeurs
      allow create, update, delete: if isTeacher();
    }
    
    // Collection authorizedTeachers
    match /authorizedTeachers/{docId} {
      // Lecture : publique (pour vérifier si un email est autorisé)
      allow read: if true;
      
      // Écriture : interdite côté client (uniquement via la console Firebase)
      allow create, update, delete: if false;
    }
    
    // Collection userProgress
    match /userProgress/{userId} {
      // Lecture : uniquement son propre document
      allow read: if isOwner(userId);
      
      // Création : uniquement son propre document avec les champs requis
      allow create: if isOwner(userId)
                   && request.resource.data.keys().hasAll(['userId', 'unlockedNodes', 'nodeStats'])
                   && request.resource.data.userId == request.auth.uid;
      
      // Mise à jour : uniquement son propre document
      allow update: if isOwner(userId)
                   && request.resource.data.userId == resource.data.userId; // Le userId ne peut pas changer
      
      // Suppression : interdite
      allow delete: if false;
    }
    
    // Collection badges
    match /badges/{badgeId} {
      // Lecture : uniquement ses propres badges
      allow read: if isAuthenticated() 
                 && resource.data.userId == request.auth.uid;
      
      // Création : un utilisateur authentifié peut créer un badge avec son propre userId
      allow create: if isAuthenticated() 
                   && request.resource.data.userId == request.auth.uid
                   && request.resource.data.keys().hasAll(['userId', 'badgeId']);
      
      // Mise à jour : uniquement son propre badge
      allow update: if isAuthenticated() 
                   && resource.data.userId == request.auth.uid
                   && request.resource.data.userId == resource.data.userId; // Le userId ne peut pas changer
      
      // Suppression : interdite (les badges sont immuables)
      allow delete: if false;
    }
    
    // Collection objectives
    match /objectives/{objectiveId} {
      // Lecture : uniquement ses propres objectifs
      allow read: if isAuthenticated() 
                 && resource.data.userId == request.auth.uid;
      
      // Création : un utilisateur authentifié peut créer un objectif avec son propre userId
      allow create: if isAuthenticated() 
                   && request.resource.data.userId == request.auth.uid
                   && request.resource.data.keys().hasAll(['userId', 'type', 'title', 'description', 'target', 'current', 'startDate', 'endDate']);
      
      // Mise à jour : uniquement son propre objectif
      allow update: if isAuthenticated() 
                   && resource.data.userId == request.auth.uid
                   && request.resource.data.userId == resource.data.userId; // Le userId ne peut pas changer
      
      // Suppression : interdite
      allow delete: if false;
    }

    // Listes de référence (établissements, classes) — lecture par tout utilisateur authentifié
    match /establishments/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isTeacher();
    }
    match /classes/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isTeacher();
    }

    // Demandes en attente (élèves proposent, profs valident/rejettent/suppriment)
    match /pendingEstablishmentRequests/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // élève envoie une demande
      allow update, delete: if isTeacher();
    }
    match /pendingClassRequests/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isTeacher();
    }

    // Classes créées par les professeurs (code partagé aux élèves pour rejoindre)
    match /teacherClasses/{classId} {
      allow read: if isAuthenticated();
      allow create: if isTeacher() && request.resource.data.teacherId == request.auth.uid;
      allow update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }

    // Devoirs (exercices assignés à une classe par le prof)
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated()
        && (resource.data.teacherId == request.auth.uid
            || (resource.data.teacherClassId != null
                && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherClassId == resource.data.teacherClassId));
      allow create: if isTeacher()
        && request.resource.data.teacherId == request.auth.uid
        && request.resource.data.keys().hasAll(['teacherId', 'teacherClassId', 'exerciseId', 'createdAt']);
      allow update, delete: if isTeacher() && resource.data.teacherId == request.auth.uid;
    }
  }
}

